define(["jquery","core/ajax","core/notification","core/str","core/templates","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g){function h(d,e){var f=d.getRoot(),g=f.find('[name="criteriaset-name"]'),h=g.val().trim(),i=!1,j=f.find(".loading-icon"),k=h.charAt(0).toUpperCase()+h.slice(1);g.val(k),f.find('[name="criteriaset-publish"]').prop("checked")&&(i=!0),j.show();var l=[];f.parent().find('[id^="id_assignfeedback_structured_critname"]').each(function(){if(a(this).val().trim().length){var b=a(this).parent().parent().next().find('[name^="assignfeedback_structured_critdesc"]');b.length||(b=a(this).parent().parent().next().find('[data-fieldtype="textarea"]'));var c;c=b.val()?b.val().trim():b.text()?b.text().trim():"",l.push({name:a(this).val().trim(),description:c})}});var m=b.call([{methodname:"assignfeedback_structured_save_criteriaset",args:{contextid:e,name:k,criteria:l,shared:i}}]);m[0].done(function(b){b.hide===!0&&(d.hide(),a("#id_assignfeedback_structured_critsetsmanage").prop("disabled",!1)),c.alert(b.title,b.body,b.label)}).fail(c.exception).always(function(){j.hide()})}var i={init:function(b,i){d.get_string("criteriasetsave","assignfeedback_structured").done(function(d){var j={canPublish:i},k=a("#id_assignfeedback_structured_critsetsave");f.create({title:d,body:e.render("assignfeedback_structured/criteriasetsave",j),type:f.types.SAVE_CANCEL,large:!1},k).done(function(c){c.getFooter().find('[data-action="save"]').prop("disabled",!0),c.getRoot().on(g.save,function(a){a.preventDefault(),h(c,b)}),c.getRoot().on(g.hidden,function(){a(this).find('[name="criteriaset-name"]').val(""),a(this).find('[name="criteriaset-publish"]').prop("checked",!1),a(this).find('[data-action="save"]').prop("disabled",!0)})}).fail(c.exception)}).fail(c.exception)}};return i});